/*
**	module.....: uhttpd2.js -- module control for uhttpd2 (Harbour)
**	version....: Front 2.0f
**  last update: 26/05/2023
**
**	(c) 2022-2023 by Carles Aubia
**
*/
const UHTTPD2_VERSION="Front 2.0f";function UHttpd2(){var e=new UDom;void 0===UHttpd2.dialog&&(UHttpd2.dialog={}),this.SetDialog=function(e){UHttpd2.dialog.function=e},this.dlg=function(){return UHttpd2.dialog},this.GetLive=function(t){var a,r=$("#"+t).find("[data-live]"),o={},n=0;for(n=0;n<r.length;n++){var s=UdomType(a=$(r[n]).attr("id")),l=e.Get(a);if("file"==s&&(a=t+"-files"),o[a]={type:"input",value:l},"radio"===s){var c=$("#"+a).attr("name"),d=$("input[name="+c+"]:checked").val();o[c]={type:"radio",value:d}}}return o},this.InitOnChange=function(e){var t=$("#"+e).find("[data-onchange]");if(0==t.length)return null;var a=this.Duplicated_Ids(t,"onchange");if(a>0)return a;for(i=0;i<t.length;i++)id=$(t[i]).attr("id"),$("#"+id).bind("change",UOnChange);return 0},this.InitOnClick=function(e){var t=$("#"+e).find("[data-onclick]");if(0==t.length)return null;var a=this.Duplicated_Ids(t,"onclick");if(a>0)return a;for(i=0;i<t.length;i++)id=$(t[i]).attr("id"),$("#"+id).bind("click",UOnClick);return 0},this.InitOnInit=function(e){if(null==(cApi=$("#"+e).data("api")))return null;var t=$("#"+e).data("oninit");if(null==t)return null;var a={};a.dlg=e,a.api=cApi,a.proc=t,a.controls=JSON.stringify(this.GetLive(e)),UShoot("api",a)},this.Duplicated_Ids=function(e,t){var a=0;return $(e).each(function(){var e=$('[id="'+this.id+'"]');e.length>1&&e[0]==this&&(a++,console.warn(t+" -> Multiple IDs #"+this.id))}),a}}function UInitDialog(e){var t=new UHttpd2;if($('[id="'+e+'"]').length>1)return console.warn("Warning!, Dialog Form id duplicated => "+e),UMsgError("<b>Dialog Form ID duplicated: </b>"+e,"<h3>System Error</h3>"),null;var a=0;a=t.InitOnChange(e),(a=t.InitOnClick(e))>0&&console.warn("Warning!, Dialog id => "+e+", maybe dont working correctly. Id's duplicated"),t.InitOnInit(e)}function UOnChange(e){var t=event.target;"object"==typeof e&&(e=""==t.id?t.offsetParent.id:t.id);var a=$("#"+e).parents("[data-dialog]");if(0==a.length)return UMsgError("<b>Error: </b> html => data-dialog tag don't defined","Programming"),!1;var r=$(a[0]).attr("id"),o=$("#"+e).data("onchange"),n=new UHttpd2,s={};s.dlg=r,s.api=$("#"+r).data("api"),s.proc=o,s.controls=JSON.stringify(n.GetLive(r)),UShoot("api",s)}$(document).ready(function(){console.info("UHTTPD2 "+UHTTPD2_VERSION)});var _TWebPBS=!1;function wait(e){for(var t=Date.now(),a=t;a-t<e;)a=Date.now()}function UOnClick(){var e,t=event.target,a={};if(!(e=""==t.id?t.offsetParent.id:t.id))return null;var r=$("#"+e).parents("[data-dialog]");if(0==r.length)return UMsgError("<b>Error: </b> Html => data-dialog tag don't defined...","Programming"),!1;var o=$(r[0]).attr("id"),n=$("#"+e).data("onclick"),s=$("#"+e).data("pbs"),l=$("#"+e).data("confirm");if("string"==typeof l&&l.length>0&&!confirm(l))return null;if("string"==typeof s)try{var c=window[s];if("function"==typeof c){a.async=!0;var d=c.apply(null,[]);if("boolean"!=typeof d||!1==d)return null}else{var u="<b>Parent Id:</b>"+o+"<br><b>Id:</b> "+e+"<br><b>pbs not found:</b> "+s;return UMsg(u,"System Error"),null}}catch(f){var u="<b>Parent Id:</b>"+o+"<br><b>Id:</b> "+e+"<br><b>Error pbs:</b> ";f instanceof SyntaxError?u+=f.message:u+=f,UMsg(u,"System Error")}var g=new UHttpd2,p={};p.dlg=o,p.api=$("#"+o).data("api"),p.proc=n,p.controls=JSON.stringify(g.GetLive(o));var h=$("#"+e).data("upload");if(h){if(1!=$("#"+h).length)return UMsgError("Error data-upload: "+h),null;UFileUpload(h,p)}else UShoot("api",p,null,null,a)}function UFileUpload(e,t,a,r){var o,n=new FormData,s="object"==$.type(t);if(0==$("#"+e).length)return nul;if(0==(o=$("#"+e)[0].files.length))return null;if(s){var l=new UHttpd2;n.append("dlg",t.dlg),n.append("api",t.api),n.append("proc",t.proc),n.append("controls",JSON.stringify(l.GetLive(t.dlg)))}else{if("function"!=typeof a)return UMsgError("UFileUpload error. Callback is missing"),null;"object"==$.type(r)&&$.each(r,(e,t)=>{n.append(e,t)})}for(i=0;i<o;i++){var c=$("#"+e)[0].files[i];n.append("file",c)}s?UShoot("api",n,!0):UShoot(t,n,!0,a)}function MsgApi(e,t,a,r,o){var n=$("[data-api='"+e+"']");if(1!=n.length){var s=!1;if("string"==typeof r)for(let l=0;l<n.length;l++){var c=$(n[l]).attr("id");if(c==r){s=!0;break}}if(!s)return console.error("Api not found: "+e),null}else var c=n.attr("id");var d=new UHttpd2;if("string"!=typeof c)return console.error("ID not defined in form with Api: "+e),null;var u=d.GetLive(c),f={};if(f.dlg=c,f.api=e,f.proc=t,f.controls=null,"object"==$.type(a))for(let g in a)a.hasOwnProperty(g)&&(u[c+"-"+g]={type:"param",value:a[g]});if(f.controls=JSON.stringify(u),"boolean"==typeof o&&o){var p={};p.async=!0,UShoot("api",f,null,null,p)}else UShoot("api",f)}function UShoot(url,oPar,lFileUpload,fCallback,oMyOptions){lFileUpload="boolean"==typeof lFileUpload&&lFileUpload,lAsyncro="boolean"==typeof lAsyncro&&lAsyncro;var cUrl=window.location.origin+"/"+url;if(lFileUpload);else if(!oPar.api||""===oPar.api)return UMsgError("<b>Error: </b> html => data-api tag don't defined","Programming"),null;void 0!==_USocket&&"object"==$.type(_USocket)&&(oPar._socket=_USocket_User);var oOptions={type:"POST",url:cUrl,data:oPar,cache:!1,async:!1,beforeSend:function(){}};if("object"==$.type(oMyOptions))for(let key in oMyOptions)oOptions[key]=oMyOptions[key];lFileUpload&&(oOptions.processData=!1,oOptions.contentType=!1);var oSend=$.ajax(oOptions).fail(function(e,t){switch(e.readyState){case 4:UMsgError("<b>Route:</b> "+url+"<hr><br>"+e.responseText,"Error");break;case 0:UMsgError("<b>Network error !</b>","Error")}});"function"==typeof fCallback?oSend.done(function(e){return fCallback.apply(null,[e])}):oSend.done(function(data){var o=new UDom;if("string"==$.type(data)){if(0==data.length)return null;try{data=jQuery.parseJSON(data)}catch(e){data&&(data.replace(/(\n)+/g,"<br />"),UMsgError(data,"System Error"))}}if(data.trace&&console.info("TRACE",data),data.console)for(i=0;i<data.console.length;i++)data.console[i][1]?console.info(data.console[i][1],data.console[i][0]):console.info(data.console[i][0]);if(data.confirm&&!confirm(data.confirm))return null;if(data.redirect){switch(data.redirect.type){case"dialog":UScreen("splash","dialog");break;case"url":location.replace(data.redirect.proc)}return null}if(data.url)return"_self"==data.url.target?window.location.replace(data.url.url):window.open(data.url.url,data.url.target,data.url.specs),null;if(data.screen&&("string"==typeof data.screen.proc?UScreen(data.screen.proc,data.screen.target,data.screen.id,data.screen.cargo):"_container"==data.screen.target&&$("#"+data.screen.id).html(data.screen.cargo)),data.window)return data.window.url&&window.open(data.window.url,data.window.target,data.window.specs),null;if(data.panel)return data.panel.id&&$("#"+data.panel.id).html(data.panel.html),null;if(data.setter)for(i=0;i<data.setter.length;i++)id=data.setter[i].id,value=data.setter[i].value,o.Set(id,value);if(data.active)for(i=0;i<data.active.length;i++)id=data.active[i].id,value=data.active[i].value,o.Active(id,value);if(data.table)for(i=0;i<data.table.length;i++){id=data.table[i].id,action=data.table[i].action,value=data.table[i].value,msgconfirm=data.table[i].msgconfirm;var oTable=new UTabulator(id);"string"==typeof msgconfirm?MsgYesNo(msgconfirm,function(){"init"==action?oTable.Init(value.options,value.events,value.filter,value.cargo):oTable.Proc(action,value)}):"init"==action?oTable.Init(value.options,value.events,value.filter,value.cargo):oTable.Proc(action,value)}if(data.class)for(i=0;i<data.class.length;i++)id=data.class[i].id,value=data.class[i].class,action=data.class[i].action,o.Class(id,value,action);if(data.visibility)for(i=0;i<data.visibility.length;i++)id=data.visibility[i].id,action=data.visibility[i].action,o.Visibility(id,action);if(data.js){var fn=window[data.js.func];if("function"==typeof fn)fn.apply(null,[data.js.data]);else try{eval(data.js.func)}catch(err){console.error("UHttpd2: "+err.message)}}if(data.error&&UMsgError(data.error,data.title),data.dialog&&UMsg(data.dialog.html,data.dialog.title,data.dialog.id,data.dialog.cargo),data.alert&&alert(data.alert),data.resetfiles&&$("#"+data.resetfiles).val(null),data.dialogclose){if(IsTWeb()){if(IsBootbox()&&data.dialogclose.id in _dialogs){var oDlg=_dialogs[data.dialogclose.id];oDlg.on("hidden.bs.modal",function(){delete _dialogs[data.dialogclose.id]}),oDlg.modal("hide")}}else id_dlg=$("#"+data.dialogclose).parent().attr("id"),!0==$("#"+id_dlg).hasClass("ui-dialog-content")&&($("#"+id_dlg).dialog("close"),$("#"+id_dlg).dialog("destroy").remove())}data.focus&&o.Focus(data.focus),data.msgapi&&MsgApi(data.msgapi.api,data.msgapi.proc,data.msgapi.param,data.msgapi.idform,!0)})}function UScreenClean(e){$("#"+e).html("")}function UScreen(e,t,a,r){t="string"==typeof t?t:"container",a="string"==typeof a&&a.length>0?a:e,r="string"==typeof r?r:"",$("#error").html("");var o={};o.dlg=a,o.type=t,$.post(e,o).done(function(o){if(!1==o.success)return o.redirect?UScreen(o.redirect.proc,o.redirect.type):UDialog("sys",o.msg,"System Error"),null;switch(t){case"_container":if(0==$("#"+a).length){var n=document.createElement("div");n.id=a,document.body.appendChild(n)}$("#"+a).html(o.html);break;case"_dialog":if($("#"+a).length>0)return null;var s="_dlg_"+a;if(0!=$("#"+s).length)return null;var l=document.createElement("div");l.id=s,document.body.appendChild(l),0==r.length&&(r="Dialog"),$("#"+s).addClass("TDlg_body").html(o.html).dialog({width:"auto",height:"auto",resizable:!1,title:r,dialogClass:"TDlg",close:function(){$(this).dialog("destroy").remove()}});break;case"_window":console.log("_window",e),window.open(e,"MyWind",a)}}).fail(function(t,a){switch(console.log("Error",t),t.readyState){case 4:UMsgError("<b>Route:</b> "+e+"<hr><br>"+t.responseText,"Error");break;case 0:UMsgError("<b>Network error !</b>","Error")}})}function UMsg(e,t,a,r){IsBootstrap()?IsBootbox()?UBootbox(e,t,a,r):UModal(e,t,"info"):UDialog("_msg_",e,t,"TDlg_Msg","info")}function UMsgError(e,t){IsBootstrap()?UModal(e,t,"error"):UDialog("_msg_",e,t,"TDlg_Msg","error")}function UDialog(e,t,a,r,o){if(a="string"==typeof a?a:"",r="string"==typeof r?r:"TDlg_Msg",0!=$("#"+(e="string"==typeof e?e:"_msg_")).length)return console.warn("Dialog exist id => "+e),null;var n=document.createElement("div");switch(n.id=e,document.body.appendChild(n),o){case"info":default:a=""===a?"Information":a;break;case"error":a=""===a?"Error System":a}var s=.8*$(window).width(),l=.8*$(window).height();switch(o){case"info":default:MsgSound("files/uhttpd2/sound/msg.mp3");break;case"error":MsgSound("files/uhttpd2/sound/msg_error.mp3")}return $("#"+e).html(t).dialog({width:"auto",height:"auto",maxWidth:s,maxHeight:l,minHeight:"auto",title:a,modal:!0,resizable:!1,dialogClass:r,open:function(){},close:function(){$(this).dialog("destroy").remove()}}),null}function UModal(e,t,a){switch(t="string"==typeof t?t:"",a){case"info":default:t=""===t?"Information":t;break;case"error":t=""===t?"Error System":t}var r='<div class="modal fade">  <div class="modal-dialog">    <div class="modal-content">';t.length>0&&(r+='      <div class="modal-header">        <h4 class="modal-title">'+t+'</h4>        <button type="button" class="close" data-dismiss="modal">&times;</button>      </div>'),r+='      <div class="modal-body" >'+e+"</body>",$(r+="    </div>  </div></div>").modal()}var _dialogs={},_dialogsId=0;function UBootbox(e,t,a,r){a="string"==typeof a?a:"id-"+ ++_dialogsId;var o={};if(o.size="",o.backdrop=!1,o.onEscape=!0,o.className="my-custom-class bounce animated","object"==$.type(r))for(let n in r)o[n]=r[n];"string"==typeof t&&(o.title=t),o.message=e;var s=bootbox.dialog(o);s.bind("shown.bs.modal",function(){s.find(".modal-content").draggable(),"focus"in o&&$("#"+o.focus).focus()}),o.size.length>0&&($(".modal").find(".modal-dialog").css("width",o.size),$(".modal").find(".modal-dialog").css("max-width","none")),_dialogs[a]=s}var _IsTWeb=!1;function SetTWeb(){_IsTWeb=!0}function IsTWeb(){return _IsTWeb}function IsBootstrap(){return"function"==typeof $().modal}function IsBootbox(){return!!bootbox}function UDom(){this.Set=function(e,t){var a=UdomType(e);switch(a){case"hidden":case"month":case"color":case"password":case"time":case"email":case"tel":case"url":case"search":case"range":case"datetime-local":case"week":case"number":case"date":case"textarea":case"text":$("#"+e).val(t);break;case"checkbox":$("#"+e).prop("checked",t);break;case"radio":""!=t?$("input[name="+e+'][ value="'+t+'"]').prop("checked",!0):$("input[name="+e+"]").prop("checked",!1);break;case"select-one":"object"==$.type(t)||"array"==$.type(t)?($("#"+e).empty(),$.each(t,function(t,a){$("#"+e).append($("<option>",{value:a}).text(a))})):$("#"+e).val(t);break;case"img":$("#"+e).attr("src",t),$("#"+e).parent().attr("href",t);break;default:$("#"+e).html(t)}},this.Get=function(e){if(void 0===e||0==e.length)return"";var t="",a=UdomType(e);switch(a){case"hidden":case"month":case"color":case"password":case"time":case"email":case"tel":case"url":case"search":case"range":case"datetime-local":case"week":case"number":case"date":case"textarea":case"text":case"select-one":t=$("#"+e).val();break;case"checkbox":t=$("#"+e).is(":checked");break;case"radio":void 0===(t=$("input[name="+e+"]:checked").val())&&(t=0);break;case"img":t=$("#"+e).attr("src");break;case"span":t=$("#"+e).html();break;case"file":var r,o=$("#"+e)[0].files,n=[];for(i=0;i<o.length;i++)(r={}).name=o[i].name,r.size=o[i].size,r.type=o[i].type,n.push(r);t=JSON.stringify(n);break;default:var s=$("#"+e).attr("class");if("string"==typeof s){if(s.indexOf("TGrid")>=0){alert("Old version. Not working"),t.selected={},t.updated={},t.data={};break}if(s.indexOf("tabulator")>=0){var l=$("#"+e).data("all");l="string"==typeof l?"SUA":"SU",t={};var c=new UTabulator(e);if(void 0===c.table)return t.selected={},t.updated={},t.data={},t;l.indexOf("S")>=0&&(t.selected=c.Proc("getSelectedData")),l.indexOf("U")>=0&&(t.updated=c.Proc("getDataChanged")),l.indexOf("A")>=0&&(t.data=c.Proc("getData"))}}else t=$("#"+e).html()}return t},this.Array2TBody=function(e){var t="";if(e.length>0)for(i=0;i<e.length;i++){for(t+="<tr>",j=0;j<e[i].length;j++)(t+="<td>","boolean"==(cType=typeof e[i][j]))?t+='<input type="checkbox" id="vehicle1" name="vehicle1" value="">':t+=e[i][j].toString(),t+="</td>";t+="</tr>"}return t},this.Active=function(e,t){var a=UdomType(e);switch(a){case"hidden":case"month":case"color":case"password":case"time":case"email":case"tel":case"url":case"search":case"range":case"datetime-local":case"week":case"number":case"date":case"textarea":case"text":case"checkbox":case"textarea":case"submit":case"button":case"select-one":$("#"+e).prop("disabled",!t);break;case"radio":$("input:radio[name="+e+"]").prop("disabled",!t);break;default:$("#"+e).html(!t)}},this.Class=function(e,t,a){switch(a){case"toggle":$("#"+e).toggleClass(t);break;case"on":$("#"+e).addClass(t);break;case"off":$("#"+e).removeClass(t)}},this.Visibility=function(e,t){var a=UdomType(e);switch(t){case"toggle":$("#"+e).toggle();break;case"on":if(IsTWeb())switch(a){case"hidden":case"month":case"color":case"password":case"time":case"email":case"tel":case"url":case"search":case"range":case"datetime-local":case"week":case"number":case"date":case"textarea":case"text":case"checkbox":case"select-one":var r=$('[data-group="'+e+'"]');1==r.length&&$(r[0]).show();break;case"radio":var r=$("input:radio[name="+e+"]");r.length>0&&1==(r=$(r[0]).parents("[data-control]")).length&&$(r[0]).show();break;default:$("#"+e).show()}else $("#"+e).show();break;case"off":if(IsTWeb())switch(a){case"hidden":case"month":case"color":case"password":case"time":case"email":case"tel":case"url":case"search":case"range":case"datetime-local":case"week":case"number":case"date":case"textarea":case"text":case"checkbox":case"select-one":var r=$('[data-group="'+e+'"]');1==r.length&&$(r[0]).hide();break;case"radio":var r=$("input:radio[name="+e+"]");r.length>0&&1==(r=$(r[0]).parents("[data-control]")).length&&$(r[0]).hide();break;default:$("#"+e).hide()}else $("#"+e).hide()}},this.Focus=function(e){$("#"+e).focus(),$("#"+e).select()}}function MsgSound(e){var t=document.createElement("audio");t.setAttribute("src",e),t.setAttribute("autoplay","autoplay")}function UdomType(e){var t=$("#"+e).prop("type");return null==t&&("radio"==$("input:radio[name="+e+"]").prop("type")?t="radio":$("#"+e).is("div")?t="div":$("#"+e).is("img")?t="img":$("#"+e).is("span")&&(t="span")),t}var _USocket=null,_USocket_User="",_USocket_Uri="";function UWS_Init(e){if(_USocket)return null;if("string"==$.type(e)&&e.search("ws://")>=0)_Usocket_Uri=e;else{if(!("string"==$.type(_USocket_Uri)||_USocket_Uri.search("ws://")>=0))return null;e=_USocket_Uri}(_USocket=new WebSocket(e)).onopen=function(t){console.log("WS >> Connection established"),_USocket_Uri=e},_USocket.onmessage=function(e){try{switch((data=jQuery.parseJSON(e.data)).type){case"msg":MsgNotify(data.value);break;case"console":console.log(data.value);break;case"js":UWS_JS(data);break;case"ws_token":_USocket_User=data.value;break;default:console.log(data)}}catch(t){console.log("WS >> "+e.data)}},_USocket.onclose=function(e){console.log("WS >> Connection closed"),_USocket=null,_USocket_User=""},_USocket.onerror=function(e){console.log("WS >> Socket engine error",e)}}function UWS_JS(e){var t=window[e.function];return"function"==typeof t&&t.apply(null,[e.value]),null}function UWS_Send(e){if(null==_USocket&&UWS_Init(),_USocket.readyState===WebSocket.OPEN){if("string"!=$.type(e)&&!(e=prompt("Entra Command","time")))return null;_USocket.send(e)}else _USocket.readyState==WebSocket.CONNECTING&&_USocket.addEventListener("open",()=>UWS_Send(e))}function UWS_Close(){if(!_USocket)return null;_USocket.send("exit")}
